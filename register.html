<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Register</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --bg-color: #1a1a1a; --surface-color: #2d2d2d; --primary-color: #3b82f6; --text-color: #ffffff; --border-color: #404040; --success-color: #22c55e; }
        body { margin: 0; background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* Layout */
        .catalog-section { flex: 1; display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border-color); }
        .ticket-section { width: 400px; background-color: #222; display: flex; flex-direction: column; }
        
        /* Grid & Tabs */
        .category-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; }
        .tab { background: var(--surface-color); border: 1px solid var(--border-color); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .tab.active { background: var(--primary-color); border-color: var(--primary-color); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; }
        .product-card { background: var(--surface-color); padding: 15px; border-radius: 12px; cursor: pointer; height: 100px; display:flex; flex-direction:column; justify-content:space-between;}
        
        /* Ticket */
        .cart-items { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .totals-area { background: var(--surface-color); padding: 20px; }
        .pay-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-pay { padding: 20px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; color: white; }
        .pay-cash { background-color: #22c55e; }
        .pay-card { background-color: #3b82f6; }
        .pay-check { background-color: #f59e0b; }

        /* Payment Modal */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:99; }
        .modal { background: #333; padding: 30px; border-radius: 12px; width: 400px; text-align: center; }
        .input-display { font-size: 1.5rem; background: #111; border: 1px solid #555; color: white; width: 100%; padding: 15px; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
        
        /* Receipt (Hidden unless printing) */
        #receipt-container { display: none; }
        @media print {
            body > * { display: none !important; }
            #receipt-container { display: block !important; width: 58mm; font-family: 'Courier New', monospace; font-size: 12px; color: black; background: white; }
            .receipt-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
            .receipt-center { text-align: center; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div class="catalog-section">
        <div class="category-tabs" id="categoryTabs"></div>
        <div class="product-grid" id="productGrid"></div>
    </div>

    <div class="ticket-section">
        <div style="padding:15px; border-bottom:1px solid #444;">
            <span id="userInfo">User</span> <button onclick="window.location.href='index.html'" style="float:right; color:red; background:none; border:none;">Exit</button>
        </div>
        <div class="cart-items" id="cartContainer"></div>
        <div class="totals-area">
            <div style="display:flex; justify-content:space-between;"><span>Total</span><span id="totalDisplay" style="font-size:1.5rem; font-weight:bold;">$0.00</span></div>
            <div class="pay-buttons">
                <button class="btn-pay pay-cash" onclick="window.openPayModal('Cash')">CASH</button>
                <button class="btn-pay pay-card" onclick="window.openPayModal('Card')">CARD</button>
                <button class="btn-pay pay-check" onclick="window.openPayModal('Check')">CHECK</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="payModal">
        <div class="modal">
            <h2 id="payMethodTitle">Payment</h2>
            
            <div id="cashUI">
                <div style="color:#aaa; margin-bottom:10px;">Amount Due: <span id="modalTotal">$0.00</span></div>
                <input type="number" id="tenderInput" class="input-display" placeholder="Enter Tender">
                <div id="changeDisplay" style="font-size:1.2rem; margin-bottom:20px; color:#22c55e; height: 20px;"></div>
                <button class="btn-pay pay-cash" style="width:100%" onclick="window.processCash()">COMPLETE SALE</button>
            </div>
            
            <div id="cardUI" style="display:none;">
                <p style="color:#ccc; margin-bottom:10px;">Process on Terminal, then enter ID:</p>
                <input type="text" id="cardTxInput" class="input-display" placeholder="Transaction ID">
                <button class="btn-pay pay-card" style="width:100%" onclick="window.processCard()">RECORD CARD SALE</button>
            </div>

            <div id="checkUI" style="display:none;">
                <input type="text" id="checkNumber" class="input-display" placeholder="Check Number">
                <button class="btn-pay pay-check" style="width:100%" onclick="window.processCheck()">RECORD CHECK</button>
            </div>

            <button onclick="document.getElementById('payModal').style.display='none'" style="margin-top:20px; background:none; border:none; color:#aaa; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="receipt-container"></div>

    <script type="module">
        import { db, collection, addDoc, updateDoc, doc, increment, getDoc, onSnapshot } from './firebase.js';

        let products = [], cart = [], categories = ["All"];
        let currentCategory = "All";
        let receiptConfig = {};
        
        async function init() {
            const u = sessionStorage.getItem('pos_user');
            if(!u) window.location.href="index.html";
            document.getElementById('userInfo').textContent = JSON.parse(u).name;

            const settings = await getDoc(doc(db, "settings", "receipt"));
            if(settings.exists()) receiptConfig = settings.data();

            onSnapshot(collection(db, "products"), snap => {
                products = snap.docs.map(d => ({id:d.id, ...d.data()}));
                const cats = [...new Set(products.map(p=>p.category))];
                categories = ["All", ...cats.sort()];
                renderCategories();
                renderGrid();
            });
        }

        // --- Render ---
        function renderCategories() {
            document.getElementById('categoryTabs').innerHTML = categories.map(c => 
                `<button class="tab ${c===currentCategory?'active':''}" onclick="window.setCat('${c}')">${c}</button>`
            ).join('');
        }
        function renderGrid() {
            const p = currentCategory==="All" ? products : products.filter(x=>x.category===currentCategory);
            document.getElementById('productGrid').innerHTML = p.map(i => 
                `<div class="product-card" onclick="window.addToCart('${i.id}')">
                    <strong>${i.name}</strong>
                    <span style="color:#3b82f6">$${parseFloat(i.price).toFixed(2)}</span>
                </div>`
            ).join('');
        }
        function renderCart() {
            const container = document.getElementById('cartContainer');
            if(cart.length===0) { container.innerHTML="Empty"; updateTotals(); return; }
            
            container.innerHTML = cart.map((item, idx) => 
                `<div class="cart-item">
                    <div>${item.name} x${item.qty}</div>
                    <div>$${(item.price*item.qty).toFixed(2)} 
                    <button onclick="window.remItem(${idx})" style="background:#333; border:none; color:white; border-radius:4px;">-</button></div>
                </div>`
            ).join('');
            updateTotals();
        }
        function updateTotals() {
            const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
            document.getElementById('totalDisplay').textContent = `$${total.toFixed(2)}`;
            document.getElementById('modalTotal').textContent = `$${total.toFixed(2)}`;
        }

        // --- Logic ---
        window.setCat = (c) => { currentCategory = c; renderCategories(); renderGrid(); }
        window.addToCart = (id) => {
            const p = products.find(x=>x.id===id);
            const ex = cart.find(x=>x.id===id);
            if(ex) ex.qty++; else cart.push({...p, qty:1});
            renderCart();
        }
        window.remItem = (idx) => {
            cart[idx].qty--;
            if(cart[idx].qty<=0) cart.splice(idx,1);
            renderCart();
        }

        window.openPayModal = (method) => {
            if(cart.length===0) return alert("Cart Empty");
            document.getElementById('payModal').style.display='flex';
            document.getElementById('payMethodTitle').innerText = method + " Payment";
            ['cashUI','cardUI','checkUI'].forEach(id => document.getElementById(id).style.display='none');
            
            if(method==='Cash') {
                document.getElementById('cashUI').style.display='block';
                document.getElementById('tenderInput').focus();
            }
            if(method==='Card') {
                document.getElementById('cardUI').style.display='block';
                document.getElementById('cardTxInput').value = "";
                document.getElementById('cardTxInput').focus();
            }
            if(method==='Check') {
                document.getElementById('checkUI').style.display='block';
                document.getElementById('checkNumber').focus();
            }
        }

        window.processCash = async () => {
            const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
            const tender = parseFloat(document.getElementById('tenderInput').value);
            if(isNaN(tender) || tender < total) return alert("Insufficient Tender");
            const change = tender - total;
            document.getElementById('changeDisplay').innerText = `Change: $${change.toFixed(2)}`;
            await completeSale('Cash', total, { tender, change });
        }

        window.processCard = async () => {
            const txId = document.getElementById('cardTxInput').value;
            if(!txId) return alert("Please enter the Square/External Transaction ID");
            const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
            await completeSale('Card', total, { txId: txId });
        }

        window.processCheck = async () => {
            const num = document.getElementById('checkNumber').value;
            if(!num) return alert("Enter Check #");
            const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
            await completeSale('Check', total, { checkNum: num });
        }

        async function completeSale(method, total, details) {
            const saleData = {
                date: new Date(),
                items: cart,
                total: total,
                method: method,
                details: details,
                status: 'complete'
            };
            const ref = await addDoc(collection(db, "sales"), saleData);
            
            cart.forEach(item => {
                updateDoc(doc(db, "products", item.id), { stock: increment(-item.qty) });
            });

            printReceipt(saleData, ref.id);
            cart = [];
            renderCart();
            document.getElementById('payModal').style.display='none';
            document.getElementById('tenderInput').value = "";
        }

        function printReceipt(sale, id) {
            const div = document.getElementById('receipt-container');
            const date = sale.date.toLocaleString();
            
            div.innerHTML = `
                <div class="receipt-center">
                    <h3>${receiptConfig.businessName || "POS System"}</h3>
                    <p>${(receiptConfig.header || "").replace(/\n/g, '<br>')}</p>
                    <p>${date}</p>
                    <p>Order #${id.slice(-4).toUpperCase()}</p>
                </div>
                <hr>
                ${sale.items.map(i => `
                    <div class="receipt-line">
                        <span>${i.qty}x ${i.name}</span>
                        <span>$${(i.price*i.qty).toFixed(2)}</span>
                    </div>
                `).join('')}
                <hr>
                <div class="receipt-line">
                    <strong>TOTAL</strong>
                    <strong>$${sale.total.toFixed(2)}</strong>
                </div>
                <div class="receipt-line">
                    <span>${sale.method}</span>
                    <span>PAID</span>
                </div>
                ${sale.method === 'Cash' ? `
                    <div class="receipt-line"><span>Tender</span><span>$${sale.details.tender.toFixed(2)}</span></div>
                    <div class="receipt-line"><span>Change</span><span>$${sale.details.change.toFixed(2)}</span></div>
                ` : ''}
                ${sale.method === 'Card' ? `
                    <div class="receipt-line"><span>Tx ID</span><span>${sale.details.txId}</span></div>
                ` : ''}
                ${sale.method === 'Check' ? `
                    <div class="receipt-line"><span>Check #</span><span>${sale.details.checkNum}</span></div>
                ` : ''}
                <hr>
                <div class="receipt-center">
                    <p>${(receiptConfig.footer || "Thank you!").replace(/\n/g, '<br>')}</p>
                </div>
            `;
            window.print();
        }

        init();
    </script>
</body>
</html>
